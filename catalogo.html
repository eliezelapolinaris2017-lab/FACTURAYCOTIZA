<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oasis ‚Äî Cat√°logo</title>
<link rel="stylesheet" href="styles.css"/></head>
<body>
<header class="topbar no-print"><div class="brand"><strong id="brandName">Oasis</strong><small>Cat√°logo</small></div></header>
<nav class="drawer-nav no-print" style="padding:10px;display:flex;gap:8px;flex-wrap:wrap">
  <a class="btn outline" href="./index.html">üßæ Nuevo</a>
  <a class="btn outline" href="./historial.html">üìö Historial</a>
  <a class="btn outline" href="./catalogo.html">üì¶ Cat√°logo</a>
  <a class="btn outline" href="./reportes.html">üìà Reportes</a>
  <a class="btn outline" href="./config.html">‚öôÔ∏è Config</a>
</nav>
<main>
<section class="panel">
  <h2>Cat√°logo</h2>
  <div class="row">
    <div class="col"><input id="itemNombre" placeholder="Nombre"/></div>
    <div class="col"><input id="itemPrecio" type="number" step="0.01" placeholder="Precio"/></div>
    <div class="col"><input id="itemFoto" type="file" accept="image/*"/></div>
    <button id="itemAgregar" class="btn primary">‚ûï Agregar</button>
  </div>
  <div class="table-wrap"><table class="table">
    <thead><tr><th>Imagen</th><th>Art√≠culo</th><th>Precio</th><th></th></tr></thead>
    <tbody id="itemsBody"></tbody>
  </table></div>
</section>
</main>

<!-- Overlay PIN -->
<div id="authOverlay" class="overlay" style="display:flex">
  <div class="card"><h1 id="authTitle">Bienvenido</h1><p id="authSubtitle"></p>
    <form id="authForm"><label>PIN</label><input id="authPin" type="password" inputmode="numeric" maxlength="6"/>
      <label id="authLabelPIN2" class="hidden">Repite el PIN</label><input id="authPin2" type="password" inputmode="numeric" maxlength="6" class="hidden"/>
      <button id="authBtn" class="btn primary" type="submit">Entrar</button><p id="authMsg" class="msg"></p></form>
  </div>
</div>

<script type="module" src="./firebase-init.js"></script>
<script type="module">
  import {Utils, Store, requirePIN, initShell} from './app-core.js';
  await requirePIN(); initShell("catalogo.html");

  function render(){
    const body=document.getElementById("itemsBody");
    const items=Store.getItems();
    body.innerHTML=items.map(it=>`
      <tr>
        <td>${it.photo?`<img src="${it.photo}" style="width:56px;height:56px;object-fit:cover;border:1px solid #000;border-radius:8px">`:""}</td>
        <td><input class="i-name" data-id="${it.id}" value="${it.name}"></td>
        <td><input class="i-price" data-id="${it.id}" type="number" step="0.01" value="${Number(it.price||0)}"></td>
        <td>
          <button class="btn i-photo" data-id="${it.id}">Foto</button>
          <button class="btn warn i-del" data-id="${it.id}">Eliminar</button>
        </td>
      </tr>`).join("");

    body.querySelectorAll(".i-name,.i-price").forEach(inp=>{
      inp.onchange=()=>{ const id=inp.dataset.id; const arr=Store.getItems(); const it=arr.find(i=>i.id===id);
        if(inp.classList.contains("i-name")) it.name=inp.value.trim();
        else it.price=parseFloat(inp.value||0);
        Store.setItems(arr);
      };
    });
    body.querySelectorAll(".i-del").forEach(b=>b.onclick=()=>{ if(!confirm("¬øEliminar √≠tem?")) return; const arr=Store.getItems().filter(i=>i.id!==b.dataset.id); Store.setItems(arr); render(); });
    body.querySelectorAll(".i-photo").forEach(b=>b.onclick=async()=>{ const id=b.dataset.id; const arr=Store.getItems(); const it=arr.find(i=>i.id===id);
      const ipt=document.createElement("input"); ipt.type="file"; ipt.accept="image/*";
      ipt.onchange=async()=>{ const f=ipt.files[0]; if(!f) return; it.photo=await Utils.fileToDataURL(f); Store.setItems(arr); render(); };
      ipt.click();
    });
  }
  render();

  document.getElementById("itemAgregar").onclick = async ()=>{
    const name=document.getElementById("itemNombre").value.trim();
    const price=parseFloat(document.getElementById("itemPrecio").value||0);
    const file=document.getElementById("itemFoto").files?.[0];
    if(!name) return alert("Nombre requerido");
    let photo=""; if(file) photo=await Utils.fileToDataURL(file);
    const arr=Store.getItems(); arr.unshift({id:Utils.uuid(), name, desc:"", price, photo}); Store.setItems(arr);
    document.getElementById("itemNombre").value=""; document.getElementById("itemPrecio").value=""; if(document.getElementById("itemFoto")) document.getElementById("itemFoto").value="";
    render();
  };
</script>
<script>if("serviceWorker" in navigator){addEventListener("load",()=>navigator.serviceWorker.register("./service-worker.js"));}</script>
</body></html>
