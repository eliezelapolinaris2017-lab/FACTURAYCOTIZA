<!doctype html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oasis — Catálogo</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<header class="topbar"><div class="icon">📦</div><div class="brand"><strong>Oasis</strong><small>Catálogo</small></div></header>
<nav class="nav"><a href="./index.html">🧾 Nuevo</a><a href="./historial.html">📚 Historial</a><a href="./catalogo.html" class="active">📦 Catálogo</a><a href="./reportes.html">📈 Reportes</a><a href="./config.html">⚙️ Config</a></nav>
<main>
<section class="panel">
  <h2>Catálogo</h2>
  <div class="row">
    <div class="col"><input id="nm" placeholder="Nombre"/></div>
    <div class="col"><input id="pr" type="number" step="0.01" placeholder="Precio"/></div>
    <div class="col"><input id="ph" type="file" accept="image/*"/></div>
    <button id="add" class="btn primary">➕ Agregar</button>
  </div>
  <table class="table"><thead><tr><th>Imagen</th><th>Ítem</th><th>Precio</th><th></th></tr></thead><tbody id="tb"></tbody></table>
</section>
</main>

<div id="loginModal" class="overlay" style="display:none"><div class="card"><h2>Accede con Google</h2><p id="loginStatus">Inicia sesión para continuar.</p><button id="btnLoginGoogle" class="btn primary">🔑 Iniciar con Google</button></div></div>

<script type="module">
  import {Sync, requireGoogleSignIn, Store, U} from './app-core.js';
  await Sync.start(); await requireGoogleSignIn();

  const tb=U.byId('tb');
  function render(){
    const it=Store.items();
    tb.innerHTML = it.map(x=>`<tr>
      <td>${x.photo?`<img src="${x.photo}" style="width:56px;height:56px;object-fit:cover;border:1px solid #000;border-radius:8px">`:""}</td>
      <td><input class="nm" data-id="${x.id}" value="${x.name}"></td>
      <td><input class="pr" data-id="${x.id}" type="number" step="0.01" value="${Number(x.price||0)}"></td>
      <td><button class="btn warn del" data-id="${x.id}">Eliminar</button> <button class="btn foto" data-id="${x.id}">Foto</button></td>
    </tr>`).join("");
  }
  render();

  U.byId('add').onclick = async ()=>{
    const name=U.byId('nm').value.trim(); if(!name) return alert("Nombre requerido");
    const price=U.toNum(U.byId('pr').value||0);
    const file=U.byId('ph').files?.[0]; const photo=file? await U.fileToDataURL(file):"";
    const arr=Store.items(); arr.unshift({id:U.uuid(), name, desc:"", price, photo}); Store.setItems(arr); render(); alert("Ítem agregado.");
  };

  tb.onclick = async (e)=>{
    const id=e.target.dataset.id; if(!id) return;
    const arr=Store.items(); const it=arr.find(i=>i.id===id); if(!it) return;
    if(e.target.classList.contains('del')){ if(!confirm("Eliminar ítem?")) return; Store.setItems(arr.filter(i=>i.id!==id)); render(); }
    if(e.target.classList.contains('foto')){ const ipt=document.createElement('input'); ipt.type="file"; ipt.accept="image/*"; ipt.onchange=async()=>{ const f=ipt.files[0]; if(!f) return; it.photo=await U.fileToDataURL(f); Store.setItems(arr); render(); }; ipt.click(); }
  };
  tb.onchange = (e)=>{ const id=e.target.dataset.id; if(!id) return; const arr=Store.items(); const it=arr.find(i=>i.id===id); if(!it) return;
    if(e.target.classList.contains('nm')) it.name=e.target.value.trim(); if(e.target.classList.contains('pr')) it.price=U.toNum(e.target.value);
    Store.setItems(arr);
  };
</script>
<script>if("serviceWorker" in navigator){addEventListener("load",()=>navigator.serviceWorker.register("./service-worker.js"));}</script>
</body>
</html>
