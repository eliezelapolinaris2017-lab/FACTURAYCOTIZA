<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oasis — Reportes</title>
<link rel="stylesheet" href="styles.css"/></head>
<body>
<header class="topbar no-print"><div class="brand"><strong id="brandName">Oasis</strong><small>Reportes</small></div></header>
<nav class="drawer-nav no-print" style="padding:10px;display:flex;gap:8px;flex-wrap:wrap">
  <a class="btn outline" href="./index.html">🧾 Nuevo</a>
  <a class="btn outline" href="./historial.html">📚 Historial</a>
  <a class="btn outline" href="./catalogo.html">📦 Catálogo</a>
  <a class="btn outline" href="./reportes.html">📈 Reportes</a>
  <a class="btn outline" href="./config.html">⚙️ Config</a>
</nav>
<main>
<section class="panel">
  <h2>Reportes</h2>
  <div class="row">
    <div class="col"><label>Desde</label><input id="repDesde" type="date"/></div>
    <div class="col"><label>Hasta</label><input id="repHasta" type="date"/></div>
    <div style="align-self:flex-end"><button id="btnFiltrar" class="btn">Filtrar</button></div>
  </div>
  <div id="repResumen" class="resumen"></div>
  <div class="table-wrap"><table class="table">
    <thead><tr><th>Tipo</th><th>Número</th><th>Fecha</th><th>Cliente</th><th>Pago</th><th>Total</th><th>Estado</th></tr></thead>
    <tbody id="repBody"></tbody>
  </table></div>

  <div class="row no-print" style="margin-top:12px">
    <button id="btnCSV" class="btn outline">📄 Exportar CSV</button>
    <button id="btnPDF" class="btn primary">🖨️ Exportar PDF</button>
  </div>
</section>
</main>

<!-- Overlay PIN -->
<div id="authOverlay" class="overlay" style="display:flex">
  <div class="card"><h1 id="authTitle">Bienvenido</h1><p id="authSubtitle"></p>
    <form id="authForm"><label>PIN</label><input id="authPin" type="password" inputmode="numeric" maxlength="6"/>
      <label id="authLabelPIN2" class="hidden">Repite el PIN</label><input id="authPin2" type="password" inputmode="numeric" maxlength="6" class="hidden"/>
      <button id="authBtn" class="btn primary" type="submit">Entrar</button><p id="authMsg" class="msg"></p></form>
  </div>
</div>

<script type="module" src="./firebase-init.js"></script>
<script type="module">
  import {Utils, Store, Docs, Printer, requirePIN, initShell} from './app-core.js';
  await requirePIN(); initShell("reportes.html");

  function filter(desde,hasta){
    const arr=Store.getDocs().filter(d=>d.status!=="anulado");
    const from=desde?new Date(desde):null; const to=hasta?new Date(hasta):null; if(to) to.setHours(23,59,59,999);
    return arr.filter(d=>{const dd=new Date(d.date); if(from && dd<from) return false; if(to && dd>to) return false; return true;});
  }
  function summarize(list){
    const s=Store.get("settings"); const out={FAC:0,COT:0,ALL:0,TFAC:0,TCOT:0,TALL:0};
    list.forEach(d=>{const t=Docs.calc(d).total; out[d.type]++; out["T"+d.type]+=t; out.ALL++; out.TALL+=t;});
    return `FAC: ${out.FAC} (${Utils.fmtMoney(out.TFAC,s.currency,s.locale)}) • COT: ${out.COT} (${Utils.fmtMoney(out.TCOT,s.currency,s.locale)}) • Total: ${out.ALL} (${Utils.fmtMoney(out.TALL,s.currency,s.locale)})`;
  }
  function render(list){
    const s=Store.get("settings");
    document.getElementById("repBody").innerHTML=list.map(d=>`<tr>
      <td>${d.type}</td><td>${d.prefix||""}${d.number}</td><td>${Utils.fmtDate(d.date,s.locale)}</td>
      <td>${d.client||""}</td><td>${d.paymentMethod||"-"}</td><td class="right">${Utils.fmtMoney(Docs.calc(d).total,s.currency,s.locale)}</td><td>${d.status}</td></tr>`).join("");
    document.getElementById("repResumen").textContent=summarize(list);
  }
  const all=Store.getDocs(); render(all);

  document.getElementById("btnFiltrar").onclick=()=>{ const d=document.getElementById("repDesde").value, h=document.getElementById("repHasta").value; render(filter(d,h)); };
  document.getElementById("btnCSV").onclick=()=>{ const d=document.getElementById("repDesde").value, h=document.getElementById("repHasta").value;
    const list=(d||h)?filter(d,h):Store.getDocs();
    const rows=[["tipo","numero","fecha","cliente","subtotal","descuento","ivu","total","estado","pago","pago_ref"]];
    list.forEach(x=>{ const c=Docs.calc(x); rows.push([x.type,`${x.prefix||""}${x.number}`,x.date,x.client||"",c.subtotal.toFixed(2),c.descAmt.toFixed(2),c.taxAmt.toFixed(2),c.total.toFixed(2),x.status,x.paymentMethod||"",x.paymentRef||""]); });
    const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); Utils.download("reporte.csv",csv,"text/csv;charset=utf-8");
  };
  document.getElementById("btnPDF").onclick=()=>{ const d=document.getElementById("repDesde").value, h=document.getElementById("repHasta").value;
    const list=(d||h)?filter(d,h):Store.getDocs();
    // Reutilizamos Printer.docHTML? mejor creamos PDF simple de tabla:
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte</title>
      <style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:12mm}
      table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px}h1{margin:0 0 8px}@page{margin:12mm}</style></head><body>
      <h1>Reporte</h1>
      <table><thead><tr><th>Tipo</th><th>Número</th><th>Fecha</th><th>Cliente</th><th>Pago</th><th>Total</th><th>Estado</th></tr></thead>
      <tbody>${list.map(x=>`<tr><td>${x.type}</td><td>${x.prefix||""}${x.number}</td><td>${Utils.fmtDate(x.date)}</td><td>${x.client||""}</td><td>${x.paymentMethod||"-"}</td><td style="text-align:right">${Utils.fmtMoney(Docs.calc(x).total)}</td><td>${x.status}</td></tr>`).join("")}</tbody>
      </table><script>onload=()=>print()</script></body></html>`;
    const w=open("","_blank"); w.document.write(html); w.document.close();
  };
</script>
<script>if("serviceWorker" in navigator){addEventListener("load",()=>navigator.serviceWorker.register("./service-worker.js"));}</script>
</body></html>
