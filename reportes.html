<!doctype html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oasis — Reportes</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<header class="topbar"><div class="icon">📈</div><div class="brand"><strong>Oasis</strong><small>Reportes</small></div></header>
<nav class="nav"><a href="./index.html">🧾 Nuevo</a><a href="./historial.html">📚 Historial</a><a href="./catalogo.html">📦 Catálogo</a><a href="./reportes.html" class="active">📈 Reportes</a><a href="./config.html">⚙️ Config</a></nav>
<main>
<section class="panel">
  <h2>Reportes</h2>
  <div class="row">
    <div class="col"><label>Desde</label><input id="d" type="date"/></div>
    <div class="col"><label>Hasta</label><input id="h" type="date"/></div>
    <div style="align-self:flex-end"><button id="f" class="btn">Filtrar</button></div>
  </div>
  <div id="sum" class="panel" style="padding:10px"></div>
  <table class="table"><thead><tr><th>Tipo</th><th>Número</th><th>Fecha</th><th>Cliente</th><th>Pago</th><th>Total</th><th>Estado</th></tr></thead><tbody id="tb"></tbody></table>
  <div class="row" style="margin-top:10px">
    <button id="csv" class="btn outline">📄 Exportar CSV</button>
    <button id="pdf" class="btn primary">🖨️ Exportar PDF</button>
  </div>
</section>
</main>

<div id="loginModal" class="overlay" style="display:none"><div class="card"><h2>Accede con Google</h2><p id="loginStatus">Inicia sesión para continuar.</p><button id="btnLoginGoogle" class="btn primary">🔑 Iniciar con Google</button></div></div>

<script type="module">
  import {Sync, requireGoogleSignIn, Store, Docs, Printer, U} from './app-core.js';
  await Sync.start(); await requireGoogleSignIn();

  const s=Store.settings();
  function filter(desde,hasta){
    const arr=Store.docs().filter(x=>x.status!=="anulado");
    const from=desde?new Date(desde):null, to=hasta?new Date(hasta):null; if(to) to.setHours(23,59,59,999);
    return arr.filter(d=>{ const dd=new Date(d.date); if(from && dd<from) return false; if(to && dd>to) return false; return true; });
  }
  function render(list){
    const tb=U.byId('tb'); tb.innerHTML = list.map(d=>`<tr>
      <td>${d.type}</td><td>${d.prefix||""}${d.number}</td><td>${U.fmtDate(d.date,s.locale)}</td><td>${d.client||""}</td>
      <td>${d.paymentMethod||"-"}</td><td class="right">${U.fmtMoney(Docs.calc(d).total,s.currency,s.locale)}</td><td>${d.status}</td></tr>`).join("");
    const sums = list.reduce((acc,d)=>{ const t=Docs.calc(d).total; acc.ALL+=t; acc["C_"+d.type]=(acc["C_"+d.type]||0)+1; acc[d.type]=(acc[d.type]||0)+t; return acc; }, {ALL:0});
    U.byId('sum').textContent = `FAC: ${sums.C_FAC||0} (${U.fmtMoney(sums.FAC||0,s.currency,s.locale)}) • COT: ${sums.C_COT||0} (${U.fmtMoney(sums.COT||0,s.currency,s.locale)}) • Total: ${U.fmtMoney(sums.ALL||0,s.currency,s.locale)}`;
  }
  const all=Store.docs(); render(all);

  U.byId('f').onclick=()=>{ render(filter(U.byId('d').value, U.byId('h').value)); };
  U.byId('csv').onclick=()=>{ const d=U.byId('d').value,h=U.byId('h').value; const list=d||h?filter(d,h):Store.docs();
    const rows=[["tipo","numero","fecha","cliente","subtotal","descuento","ivu","total","estado","pago","pago_ref"]];
    list.forEach(x=>{ const c=Docs.calc(x); rows.push([x.type,`${x.prefix||""}${x.number}`,x.date,x.client||"",c.subtotal.toFixed(2),c.descAmt.toFixed(2),c.taxAmt.toFixed(2),c.total.toFixed(2),x.status,x.paymentMethod||"",x.paymentRef||""]); });
    U.download("reporte.csv", rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"));
  };
  U.byId('pdf').onclick=()=>{ const d=U.byId('d').value,h=U.byId('h').value; const list=d||h?filter(d,h):Store.docs();
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte</title>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:12mm}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:6px}h1{margin:0 0 8px}@page{margin:12mm}</style></head><body>
    <h1>Reporte</h1>
    <table><thead><tr><th>Tipo</th><th>Número</th><th>Fecha</th><th>Cliente</th><th>Pago</th><th>Total</th><th>Estado</th></tr></thead>
    <tbody>${list.map(x=>`<tr><td>${x.type}</td><td>${x.prefix||""}${x.number}</td><td>${U.fmtDate(x.date)}</td><td>${x.client||""}</td><td>${x.paymentMethod||"-"}</td><td style="text-align:right">${U.fmtMoney(Docs.calc(x).total)}</td><td>${x.status}</td></tr>`).join("")}</tbody></table>
    <script>onload=()=>print()</script></body></html>`;
    const w=open("","_blank"); w.document.write(html); w.document.close();
  };
</script>
<script>if("serviceWorker" in navigator){addEventListener("load",()=>navigator.serviceWorker.register("./service-worker.js"));}</script>
</body>
</html>
