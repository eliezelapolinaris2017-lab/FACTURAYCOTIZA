<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Oasis ‚Äî Nuevo</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <!-- Top -->
  <header class="topbar no-print">
    <div class="brand"><strong id="brandName">Oasis</strong><small>Facturaci√≥n y Cotizaciones</small></div>
  </header>

  <!-- Men√∫ lateral m√≠nimo -->
  <nav class="drawer-nav no-print" style="padding:10px;display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn outline" href="./index.html">üßæ Nuevo</a>
    <a class="btn outline" href="./historial.html">üìö Historial</a>
    <a class="btn outline" href="./catalogo.html">üì¶ Cat√°logo</a>
    <a class="btn outline" href="./reportes.html">üìà Reportes</a>
    <a class="btn outline" href="./config.html">‚öôÔ∏è Config</a>
  </nav>

  <main>
    <section class="panel">
      <h2>Nuevo Documento</h2>
      <form id="docForm" autocomplete="off">
        <div class="row">
          <div class="col">
            <label>Tipo</label>
            <select id="docTipo"><option value="FAC">Factura</option><option value="COT">Cotizaci√≥n</option></select>
          </div>
          <div class="col">
            <label>Prefijo</label>
            <input id="docPrefijo" />
          </div>
          <div class="col">
            <label>N√∫mero</label>
            <input id="docNumero" inputmode="numeric" />
          </div>
          <div class="col">
            <label>Fecha</label>
            <input id="docFecha" type="date" />
          </div>
        </div>

        <label>Cliente</label>
        <input id="docCliente" placeholder="Nombre o empresa" />

        <div class="lines-header" style="margin-top:10px">
          <h3>Art√≠culos / Servicios</h3>
          <div class="inline">
            <select id="catalogQuickAdd"><option value="">‚Äî del cat√°logo ‚Äî</option></select>
            <button type="button" id="btnQuickAdd" class="btn">Agregar</button>
            <button type="button" id="btnAddLinea" class="btn outline">+ L√≠nea</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Art√≠culo</th><th>Descripci√≥n</th><th>Precio</th><th>Cant.</th><th>Importe</th><th></th></tr></thead>
            <tbody id="lineasBody"></tbody>
          </table>
        </div>

        <div class="row totals">
          <div class="col"><label>Descuento (%)</label><input id="docDescuento" type="number" step="0.01" /></div>
          <div class="col"><label>IVU (%)</label><input id="docImpuesto" type="number" step="0.01" /></div>
          <div class="col"><label>M√©todo de pago</label>
            <select id="docPago"><option value="">‚Äî seleccionar ‚Äî</option><option>Efectivo</option><option>Cheque</option><option>ATH</option><option>ATH M√≥vil</option><option>PayPal</option></select>
          </div>
          <div class="col"><label>Ref. Pago</label><input id="docPagoRef" /></div>
        </div>

        <div class="sumas" id="sumas">
          <div>Subtotal: <strong id="sumSubtotal">$0.00</strong></div>
          <div>Descuento: <strong id="sumDesc">$0.00</strong></div>
          <div>IVU: <strong id="sumImpuesto">$0.00</strong></div>
          <div>Total: <strong id="sumTotal">$0.00</strong></div>
        </div>

        <label>Notas</label>
        <textarea id="docNotas" rows="3"></textarea>

        <div class="row no-print" style="margin-top:12px">
          <button type="button" id="btnGuardarBorrador" class="btn">üíæ Borrador</button>
          <button type="submit" id="btnGuardarFinal" class="btn primary">üñ®Ô∏è Guardar y PDF</button>
        </div>
      </form>
    </section>
  </main>

  <button id="btnHome" class="pwa-home">üè† Volver al inicio</button>

  <!-- Overlay PIN -->
  <div id="authOverlay" class="overlay" style="display:flex">
    <div class="card">
      <h1 id="authTitle">Bienvenido</h1>
      <p id="authSubtitle">Crea un PIN para proteger tus datos.</p>
      <form id="authForm">
        <label for="authPin">PIN</label>
        <input id="authPin" type="password" inputmode="numeric" maxlength="6" placeholder="4‚Äì6 d√≠gitos" required />
        <label id="authLabelPIN2" for="authPin2" class="hidden">Repite el PIN</label>
        <input id="authPin2" type="password" inputmode="numeric" maxlength="6" class="hidden" />
        <button id="authBtn" class="btn primary" type="submit">Guardar PIN</button>
        <p id="authMsg" class="msg"></p>
      </form>
    </div>
  </div>

  <script type="module" src="./firebase-init.js"></script>
  <script type="module">
    import {Utils, Store, Numbering, Docs, Printer, requirePIN, initShell, Session} from './app-core.js';

    // Requiere PIN y prepara shell
    await requirePIN();
    initShell("index.html");

    const s=Store.get("settings");
    // --- estado inicial
    const doc = Docs.empty();
    document.getElementById("docTipo").value = doc.type;
    document.getElementById("docPrefijo").value = doc.prefix;
    document.getElementById("docNumero").value = doc.number;
    document.getElementById("docFecha").value = doc.date;

    function addLineaRow(l={name:"",desc:"",price:0,qty:1}){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td><input class="l-name" placeholder="Nombre" value="${l.name}"></td>
      <td><input class="l-desc" placeholder="Descripci√≥n" value="${l.desc||""}"></td>
      <td><input class="l-price" type="number" step="0.01" inputmode="decimal" value="${Number(l.price||0)}"></td>
      <td><input class="l-qty" type="number" step="1" inputmode="numeric" value="${Number(l.qty||1)}"></td>
      <td class="right l-imp">$0.00</td>
      <td><button class="btn warn btn-del" type="button">X</button></td>`;
      const recalc=()=>{const imp=Utils.toNum(tr.querySelector(".l-price").value)*Utils.toNum(tr.querySelector(".l-qty").value||1); tr.querySelector(".l-imp").textContent=Utils.fmtMoney(imp,s.currency,s.locale); updateTotals();};
      tr.querySelectorAll("input").forEach(i=>i.addEventListener("input",recalc));
      tr.querySelector(".btn-del").addEventListener("click",()=>{tr.remove(); updateTotals();});
      document.getElementById("lineasBody").appendChild(tr); recalc();
    }
    addLineaRow();

    function collectDoc(){
      const lines=[...document.querySelectorAll("#lineasBody tr")].map(tr=>({
        name:tr.querySelector(".l-name").value.trim(),
        desc:tr.querySelector(".l-desc").value.trim(),
        price:Utils.toNum(tr.querySelector(".l-price").value),
        qty:Utils.toNum(tr.querySelector(".l-qty").value||1)
      })).filter(l=>l.name||l.desc||l.price);
      return {
        id: doc.id,
        type: document.getElementById("docTipo").value,
        prefix: document.getElementById("docPrefijo").value || Numbering.prefix(document.getElementById("docTipo").value),
        number: Utils.toNum(document.getElementById("docNumero").value)||doc.number,
        date: document.getElementById("docFecha").value || Utils.todayISO(),
        client: document.getElementById("docCliente").value.trim(),
        discountPct: Utils.toNum(document.getElementById("docDescuento").value||0),
        taxPct: Utils.toNum(document.getElementById("docImpuesto").value||0),
        paymentMethod: document.getElementById("docPago").value || "",
        paymentRef: document.getElementById("docPagoRef").value.trim() || "",
        notes: document.getElementById("docNotas").value.trim(),
        lines,
        status: "borrador"
      };
    }

    function updateTotals(){
      const d=collectDoc(); const t = Docs.calc(d);
      document.getElementById("sumSubtotal").textContent = Utils.fmtMoney(t.subtotal,s.currency,s.locale);
      document.getElementById("sumDesc").textContent = Utils.fmtMoney(t.descAmt,s.currency,s.locale);
      document.getElementById("sumImpuesto").textContent = Utils.fmtMoney(t.taxAmt,s.currency,s.locale);
      document.getElementById("sumTotal").textContent = Utils.fmtMoney(t.total,s.currency,s.locale);
    }
    document.getElementById("btnAddLinea").addEventListener("click",()=>addLineaRow());
    document.getElementById("docDescuento").addEventListener("input",updateTotals);
    document.getElementById("docImpuesto").addEventListener("input",updateTotals);

    // cat√°logo quick add
    function fillQuickAdd(){
      const items=Store.getItems();
      const sel=document.getElementById("catalogQuickAdd");
      sel.innerHTML = `<option value="">‚Äî del cat√°logo ‚Äî</option>` + items.map(i=>`<option value="${i.id}">${i.name} (${Utils.fmtMoney(i.price)})</option>`).join("");
    }
    fillQuickAdd();
    document.getElementById("btnQuickAdd").addEventListener("click",()=>{
      const id=document.getElementById("catalogQuickAdd").value; if(!id) return;
      const it=Store.getItems().find(i=>i.id===id); if(!it) return;
      addLineaRow({name:it.name,desc:it.desc||"",price:it.price||0,qty:1});
    });

    // Guardar
    document.getElementById("btnGuardarBorrador").addEventListener("click",()=>{
      const d=collectDoc(); d.status="borrador"; Store.saveDoc(d);
      if (window.OasisSync?.syncToFirebase) window.OasisSync.syncToFirebase();
      alert("Borrador guardado.");
    });
    document.getElementById("docForm").addEventListener("submit",(e)=>{
      e.preventDefault();
      const d=collectDoc(); d.status="final"; Store.saveDoc(d);
      if (window.OasisSync?.syncToFirebase) window.OasisSync.syncToFirebase();
      Printer.openPrint(Printer.docHTML(d));
    });
  </script>

  <!-- SW -->
  <script>
    if ("serviceWorker" in navigator) {
      addEventListener("load", ()=>navigator.serviceWorker.register("./service-worker.js"));
    }
  </script>
</body>
</html>
